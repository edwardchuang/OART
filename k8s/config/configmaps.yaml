apiVersion: v1
kind: ConfigMap
metadata:
  name: map-config
  namespace: default
data:
  config.json: |
    {
      "options": {
        "paths": {
          "root": "/usr/src/app/node_modules/tileserver-gl-styles",
          "fonts": "fonts",
          "styles": "styles",
          "mbtiles": "/data"
        }
      },
      "styles": {
        "basic-preview": {
          "style": "basic-preview/style.json"
        }
      },
      "data": {
        "v3": {
          "mbtiles": "map.mbtiles"
        }
      }
    }

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: oart-db-script
  namespace: default
data:
  ingest.py: |
    import sqlite3
    import socket
    import time
    import os
    import sys

    DB_PATH = "/data/adsb_history.db"
    HOST = os.getenv("READSB_HOST", "oart-decoder-svc")
    PORT = int(os.getenv("READSB_PORT", "30003"))

    def init_db():
        conn = sqlite3.connect(DB_PATH)
        conn.enable_load_extension(True)
        
        # Load Spatialite
        spatialite_loaded = False
        for path in ["mod_spatialite.so", "/usr/lib/x86_64-linux-gnu/mod_spatialite.so", "mod_spatialite"]:
            try:
                conn.load_extension(path)
                spatialite_loaded = True
                break
            except:
                continue
        
        c = conn.cursor()
        if spatialite_loaded:
            print("Spatialite extension loaded successfully.")
            # Initialize spatial metadata if not exists
            try:
                c.execute("SELECT InitSpatialMetadata(1)")
            except:
                pass
        
        # Create table with geometry support
        c.execute("""
            CREATE TABLE IF NOT EXISTS aircraft_positions (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                icao TEXT NOT NULL,
                callsign TEXT,
                alt INTEGER,
                lat REAL,
                lon REAL,
                track_id TEXT,
                timestamp DATETIME DEFAULT CURRENT_TIMESTAMP
            );
        """)
        
        # Schema Migration: Add track_id if it doesn't exist
        try:
            c.execute("ALTER TABLE aircraft_positions ADD COLUMN track_id TEXT")
        except sqlite3.OperationalError:
            pass # Column already exists
        
        # Add Geometry column if it doesn't exist
        if spatialite_loaded:
            try:
                c.execute("SELECT AddGeometryColumn('aircraft_positions', 'geom', 4326, 'POINT', 'XY')")
                c.execute("SELECT CreateSpatialIndex('aircraft_positions', 'geom')")
            except:
                pass
        
        conn.commit()
        return conn

    def main():
        print(f"Connecting to {HOST}:{PORT} for SBS data...", flush=True)
        conn = init_db()
        
        last_seen = {} # {icao: timestamp}
        track_sessions = {} # {icao: track_id}
        msg_count = 0
        pos_count = 0
        
        while True:
            try:
                s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                s.settimeout(15)
                s.connect((HOST, PORT))
                print(f"Connected to {HOST}:{PORT}. Listening for messages...", flush=True)
                f = s.makefile()
                for line in f:
                    msg_count += 1
                    if msg_count % 100 == 0:
                        print(f"SBS Stream Status: {msg_count} messages received, {pos_count} positions saved.", flush=True)
                    
                    parts = line.strip().split(',')
                    if len(parts) >= 15 and parts[0] == "MSG":
                        msg_type = parts[1]
                        icao = parts[4]
                        now = time.time()
                        
                        # Session logic: new track if seen > 15 mins ago
                        if icao not in last_seen or (now - last_seen[icao]) > 900:
                            track_sessions[icao] = f"{icao}_{int(now)}"
                        
                        last_seen[icao] = now
                        
                        if msg_type == "3":
                            alt = parts[11]
                            lat = parts[14]
                            lon = parts[15]
                            if lat and lon:
                                pos_count += 1
                                c = conn.cursor()
                                track_id = track_sessions[icao]
                                c.execute(
                                    """INSERT INTO aircraft_positions 
                                       (icao, alt, lat, lon, track_id, geom) 
                                       VALUES (?, ?, ?, ?, ?, MakePoint(CAST(? AS REAL), CAST(? AS REAL), 4326))""",
                                    (icao, alt, lat, lon, track_id, lon, lat)
                                )
                                conn.commit()
                s.close()
            except Exception as e:
                print(f"Connection lost or error: {e}. Retrying in 5s...", flush=True)
                time.sleep(5)

    if __name__ == "__main__":
        main()
